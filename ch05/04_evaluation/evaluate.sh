#!/bin/bash

# --- Script Description ---
# This script is the second part of the evaluation pipeline.
# It runs the RAG system (index and query), extracts keypoints
# from the RAG output, and calculates global, retrieval, and
# generation metrics.
#
# It requires the output directory from Part 1 and the number
# of documents used for metrics.

# --- Usage Function ---
usage() {
    echo "Usage: $0 --input-dir <path> --num-docs <int>"
    echo ""
    echo "Options:"
    echo "  --input-dir <path> : Directory containing the groundtruth data generated by generate_synthetic_qa_pairs.sh (e.g., data_eval/v20250501)"
    echo "  --num-docs <int> : Number of documents/pairs used for keypoint extraction and metric calculations (e.g., 100)"
    echo "  --rag-output-dir <path> : RAG directory where all eval metrics will be stored (e.g., data_eval/v20250501)"
    echo "  -h, --help         : Show this help message"
    echo ""
    echo "Example:"
    echo "  $0 --input-dir ./eval_data_20231231 --num-docs 150"
}

# --- Parse Arguments ---
# Set initial values to empty - we'll require all of them
INPUT_BASE_DIR=""
NUM_METRIC_DOCS=""

# Loop through arguments
while [[ "$#" -gt 0 ]]; do
    case "$1" in
        --input-dir) INPUT_BASE_DIR="$2"; shift ;;
        --num-docs) NUM_METRIC_DOCS="$2"; shift ;;
        --rag-output-dir) RAG_OUTPUT_DIR="$2"; shift ;;
        -h|--help) usage; exit 0 ;;
        *) echo "Error: Unknown parameter passed: $1"; usage; exit 1 ;;
    esac
    shift # Consume the argument (either option or value if no shift happened inside case)
done

# --- Validate Arguments ---
if [ -z "$INPUT_BASE_DIR" ] || [ -z "$RAG_OUTPUT_DIR" ] || [ -z "$NUM_METRIC_DOCS" ]; then
    echo "Error: Missing required arguments."
    usage
    exit 1
fi

# Check if input directory exists
if [ ! -d "$INPUT_BASE_DIR" ]; then
    echo "Error: Input directory '$INPUT_BASE_DIR' not found."
    exit 1
fi

# Create necessary output directories
echo "Creating output directory for RAG results and metrics: $RAG_OUTPUT_DIR"
mkdir -p "$RAG_OUTPUT_DIR" || { echo "Error: Failed to create directory '$RAG_OUTPUT_DIR'."; exit 1; }

# --- Set Derived Variables and Create Directory ---
RAG_RAW_OUTPUT_PATH="${RAG_OUTPUT_DIR}/raw_output.json"
KEYPOINTS_PATH="${INPUT_BASE_DIR}/keypoints.json"
RAG_KEYPOINTS_PATH="${RAG_OUTPUT_DIR}/keypoints.json"


# --- Execute Steps (Part 2) ---

# Step 5a: run the RAG system (Index)
echo "--- Step 0a: Running RAG index step ---"
# Assuming naive_rag.index.py doesn't need parameters based on the original script
python naive_rag.index.py || { echo "Error during Step 5a. Aborting."; exit 1; }

# Step 5b: run the RAG system (Query)
echo "--- Step 0b: Running RAG query step ---"
# The RAG query step needs the rewritten questions from Part 1 as input,
# and saves its raw output, which will then be processed for keypoints.
# Assuming naive_rag.query.py takes the rewritten questions path.
# Output goes to a temporary file within the RAG output dir.

if [ ! -f "$KEYPOINTS_PATH" ]; then
    echo "Error: Rewritten questions file not found at '$KEYPOINTS_PATH'. Make sure Part 1 was run successfully."
    exit 1
fi

python naive_rag.query.py \
    --questions_path "$KEYPOINTS_PATH" \
    --output_path "$RAG_RAW_OUTPUT_PATH" || { echo "Error during Step 5b. Aborting."; exit 1; }

echo "--- Step 1: Extracting keypoints from RAG output ---"

python 01_extract_keypoints.py \
    --response \
    --input_path "$RAG_RAW_OUTPUT_PATH" \
    --output_path "$RAG_KEYPOINTS_PATH" || { echo "Error during RAG keypoint extraction step. Aborting."; exit 1; }

# Validate that RAG keypoints file was created before proceeding
if [ ! -f "$RAG_KEYPOINTS_PATH" ]; then
    echo "Error: RAG keypoints file '$RAG_KEYPOINTS_PATH' was not created."
    exit 1
fi

# Variable to track overall success of parallel jobs
overall_status=0

# Step 6: calculate the global metrics
echo "Starting Step 6: Calculating global metrics..."
python 02_calculate_global_metrics.py \
    --num_docs "$NUM_METRIC_DOCS" \
    --precision --recall \
    --input_path "$RAG_KEYPOINTS_PATH" \
    --output_dir "$RAG_OUTPUT_DIR" &
PID_GLOBAL=$! # Capture the Process ID of the background job

# Step 7: calculate the retrieval metrics
echo "Starting Step 7: Calculating retrieval metrics..."
python 02_calculate_retrieval_metrics.py \
    --num_docs "$NUM_METRIC_DOCS" \
    --precision --recall \
    --input_path "$RAG_KEYPOINTS_PATH" \
    --output_dir "$RAG_OUTPUT_DIR" &
PID_RETRIEVAL=$! # Capture the Process ID

# Step 8: calculate the generation metrics
echo "Starting Step 8: Calculating generation metrics..."
python 02_calculate_generation_metrics.py \
    --num_docs "$NUM_METRIC_DOCS" \
    --loyalty --hallucination --noise-sensitivity --context-utility-ratio \
    --input_path "$RAG_KEYPOINTS_PATH" \
    --output_dir "$RAG_OUTPUT_DIR" &
PID_GENERATION=$! # Capture the Process ID

# --- Wait for Parallel Jobs to Finish and Check Status ---

# Wait for each job and check its exit status
echo "Waiting for global metrics calculation (PID: $PID_GLOBAL)..."
wait $PID_GLOBAL
STATUS_GLOBAL=$?
if [ $STATUS_GLOBAL -ne 0 ]; then
    echo "Error: Global metrics calculation (Step 6, PID $PID_GLOBAL) failed with status $STATUS_GLOBAL."
    overall_status=1
fi

echo "Waiting for retrieval metrics calculation (PID: $PID_RETRIEVAL)..."
wait $PID_RETRIEVAL
STATUS_RETRIEVAL=$?
if [ $STATUS_RETRIEVAL -ne 0 ]; then
    echo "Error: Retrieval metrics calculation (Step 7, PID $PID_RETRIEVAL) failed with status $STATUS_RETRIEVAL."
    overall_status=1
fi

echo "Waiting for generation metrics calculation (PID: $PID_GENERATION)..."
wait $PID_GENERATION
STATUS_GENERATION=$?
if [ $STATUS_GENERATION -ne 0 ]; then
    echo "Error: Generation metrics calculation (Step 8, PID $PID_GENERATION) failed with status $STATUS_GENERATION."
    overall_status=1
fi

# --- Final Status Check ---

if [ $overall_status -ne 0 ]; then
    echo "--- Parallel metric calculations finished with errors. Some steps failed. ---"
    exit 1 # Exit with a non-zero status to indicate failure
else
    echo "--- All parallel metric calculations completed successfully! ---"
    echo "--- Part 2 completed successfully! RAG results and metrics are in $RAG_OUTPUT_DIR ---"
    exit 0 # Exit with zero status to indicate success
fi